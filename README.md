# -DWH

Большинство задач, где требуется разработка DWH, будут реализованы с помощью многослойной архитектуры. Сама верхнеуровневая модель хранилища — это сочетание слоёв. А значит, без проектирования слоёв не обойтись. Чтобы выбрать слои, из которых будет состоять ваш DWH, повторим, какие из них — обязательные и для чего нужен каждый слой.

В реальной жизни вы можете увидеть, что слои данных тоже называются хранилищами, как и DWH. Чтобы избежать недопонимания, в наших уроках мы будем использовать термин «хранилище», говоря о DWH.

На практике само хранилище чаще всего проектируют другие люди с соответствующими компетенциями и обязанностями, а инженер данных, в свою очередь, создаёт слои, строит модели и процессы, которые загружают и обрабатывают данные.

Представьте, что ваше хранилище — это кухня ресторана, а пользователь — посетитель. На кухне каждый занимается своим делом: делает заготовки, готовит соусы, оформляет блюдо. Суть разделения DWH на слои та же: разбить доставку данных от источника до пользователя на этапы. У каждого из них своя цель, как и у моделей данных или технологий, с помощью которых они сделаны.

Если правильно разделить хранилище на слои и построить ETL/ELT-процессы, то оно будет надёжным, быстрым и устойчивым к изменениям. В идеальном хранилище:
- Каждый слой оптимизирован под собственные задачи.
- Ошибки в одном слое не затрагивают последующие слои.
- Разделение доступа позволяет пользователям разной квалификации работать с нужным слоем. Например, для работы со слоем Reporting, скорее всего, не потребуется даже знание SQL. К тому же над каждым из слоёв может работать отдельная команда инженеров данных.

## Какие слои есть в хранилище
Слои, или уровни (от англ. layer), — это самостоятельные компоненты, такие как БД, СУБД или файловые системы с собственной архитектурой. Часто в корпоративных хранилищах слои создаются разными технологиями.
Когда говорят о слоях хранилища, чаще всего имеют в виду пять основных слоёв:
- STG (Staging) — хранилище консолидированной информации из источников.
- ODS (Operational Data Store) — хранилище операционных данных.
- DDS (Detail Data Store) — хранилище детальных исторических данных.
- CDM (Common Data Marts) — слой широких витрин.
- REP (Reporting) — слой детальных витрин, или отчётов.

При этом не каждое хранилище содержит все слои. Но если определять обычный минимальный набор, то он будет таким:
- STG
- DDS
- CDM

Часто каждый слой использует разные типы СУБД. В более простых системах, где объём данных не так велик, для всех слоёв можно использовать классические реляционные базы данных, такие как PostgreSQL, который вы и будете использовать при создании вашего DWH.


## Staging
Staging — первый слой в хранилище. Это значит, что данные из систем-источников сначала попадают именно в него.

В различной литературе этот слой может иметь разные названия: STG, staging-область или staging area, staging, stage. Иногда его называют RAW, ведь цель слоя — хранить сырые данные. Причём сохраняются они as is, то есть как есть. Если продолжать аналогию с рестораном, то это кладовка.
Основные функции staging-области:

- Сбор сырых данных из нескольких источников Staging может содержать данные из источников разного формата: реляционных и документоориентированных СУБД, сырых файлов и запросов к API по http/https или gRPC. В таком случае витрину не получится создать вообще или не выйдет написать SQL-запрос для её обновления, потому что части данных может не хватить и витрина в итоге будет содержать неверную информацию.
- Снятие нагрузки с систем-источников Витрины, или ETL-процессы, часто используют сложные запросы, которые могут нагрузить системы-источники. Именно поэтому данные из них переносятся в staging-область as is, и тогда запросы ETL на построение следующих слоёв будут строиться уже к staging.
- Архивирование и устранение неполадок
- ETL-процесс не всегда завершается успешно, и даже при успешном завершении обработанные данные в следующих слоях могут не пройти тестирование.И тогда сырые данные из staging-слоя используют для устранения таких ошибок.

Иногда на staging накладывают функции других слоёв: там происходит подготовка, очистка и предрасчёт агрегатов — получается STG, ODS, DDS и отчасти CDM в одном лице. Но почему не стоит использовать staging как источник для построения витрин и отчётов?

- Выполнение всех шагов по очистке и предрасчёту может выйти за рамки временного интервала на загрузку данных, из-за этого не загрузится следующая порция данных из систем-источников, и они будут накапливаться, как снежный ком.
- Хранение всех исторических данных в staging сделает его размер огромным, а загрузку данных из источников в него — долгой.
- Появится ограничение — staging-слой обязательно должен быть реляционной БД. Без этого не построить модель «снежинку» или «звезду».
- Связи между данными либо строятся долго и сложно, либо вообще не строятся и находятся только в голове инженера данных, который был автором модели. В staging-области связи могут быть построены частично логически, тогда как в ODS и DDS данные обязательно физически связаны внешними ключами.

## Operational Data Store
В ODS, или операционном хранилище, обычно хранятся только детальные данные в реляционном формате. Этот слой не содержит агрегированных данных.

ODS может напрямую использоваться для построения слоя CDM. Для компании ODS служит источником оперативных данных, то есть в отличие от DDS данные из него не используют, чтобы принимать тактические и стратегические решения, но могут собрать на их основе оперативный отчёт. Это своего рода хранилище с заготовками продуктов.
У ODS есть два подхода к хранению данных:
- Содержит только текущие данные без историчности. Тогда ODS — всего лишь один из этапов нормализации и очистки в ETL либо же источник текущей информации для CDM.
- Данные полностью интегрируются, то есть физически связываются между собой, иногда даже в 3НФ, и историчность сохраняется.

Основные функции ODS:
- Интеграция данных В этом слое мы производим интеграцию различных источников в реляционную модель.
- Очистка данных Очистка данных включает поиск и удаление, или обновление, недействительных данных из исходных систем.
Источник данных ODS может служить источником оперативных данных как для следующего слоя, например DDS, куда добавляются новые данные, если этот слой есть в вашем хранилище, так и для CDM.

## Detail Data Store
DDS, детальное хранилище данных, — сердце любого хранилища. Он всегда будет его ядром и входит в минимальный набор слоёв.

Данные в DDS хранятся в реляционном формате и имеют различную степень нормализации — уже не заготовки, а скорее полуфабрикаты.
Основные функции:
- Сохранение полной истории изменения сущностей и связей между данными.
- Проведение исторического анализа и анализа тенденций на больших объёмах данных.

## Common Data Marts
CDM — слой ключевых витрин данных. Чаще всего это широкие витрины с агрегатами и показателями, полезными для бизнеса. Данные могут быть сильно детализированы. Глубина детализации может достигать уровня пользователя — то есть компания может узнать много детальной информации про конкретных пользователей.
Пользователь может обращаться напрямую в CDM для получения необходимых данных, но это не всегда удобно и чаще всего пользователи DWH обращаются именно к REP. Если же данных в REP недостаточно, то можно переходить к CDM.
Витрины собираются на регламентной основе из множества источников в DDS или ODS, благодаря которым аналитики могут быстро ответить на вопросы заказчиков. По аналогии с рестораном это почти готовые блюда.
Основные функции:
- Предоставление информации Компания получает детальную информацию, на основе которой могут приниматься бизнес-решения.
Reporting
- Слой REP — продукт конечного использования. Данные в этом слое полностью отвечают на запросы пользователя.
REP появляется, когда есть необходимость разделить функционал: CDM — для постоянного переиспользования в задачах, REP — для конкретной задачи.
Это уже полностью готовое блюдо. В REP лежит таблица — результат запроса, который получает данные в рамках решения конкретной задачи. Такую таблицу удобно визуализировать в BI — это будет наглядно для пользователей DWH.
REP — не обязательный слой и присутствует не во всех архитектурах хранилищ, поэтому слой витрин может стать финальным для пользователя.
Основные функции:
- Предоставлять пользователю информацию в виде таблицы с результатом запроса

